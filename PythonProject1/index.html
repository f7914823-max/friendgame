<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–≥—Ä–æ–≤–æ–π –ë–æ—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            color: white;
            font-family: 'Arial', sans-serif;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .nav-tabs {
            border-bottom: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        .nav-tabs .nav-link {
            color: white;
            border: none;
            padding: 15px 20px;
            transition: background 0.3s;
        }
        .nav-tabs .nav-link:hover, .nav-tabs .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
        }
        .tab-content {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 10px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .game-btn {
            background: #ff6b6b;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            transition: background 0.3s;
        }
        .game-btn:hover {
            background: #e55a5a;
        }
        input.form-control {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
        }
        input.form-control::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .icon { margin-right: 10px; }
        .alert {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile"><i class="fas fa-user icon"></i>–ü—Ä–æ—Ñ–∏–ª—å</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="friends-tab" data-bs-toggle="tab" data-bs-target="#friends"><i class="fas fa-users icon"></i>–î—Ä—É–∑—å—è</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="games-tab" data-bs-toggle="tab" data-bs-target="#games"><i class="fas fa-dice icon"></i>–ò–≥—Ä—ã</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks"><i class="fas fa-tasks icon"></i>–ó–∞–¥–∞–Ω–∏—è</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="profile" role="tabpanel">
                <div class="card p-3 mb-3">
                    <h3><i class="fas fa-user-circle"></i> –ü—Ä–æ—Ñ–∏–ª—å</h3>
                    <p id="username">Username: @...</p>
                    <p id="balance">–ë–∞–ª–∞–Ω—Å: 1000 üí∞</p>
                </div>
            </div>
            <div class="tab-pane fade" id="friends" role="tabpanel">
                <h3><i class="fas fa-users"></i> –î—Ä—É–∑—å—è</h3>
                <div class="input-group mb-3">
                    <input type="text" id="friendInput" placeholder="Username –¥—Ä—É–≥–∞ (–±–µ–∑ @)" class="form-control">
                    <button onclick="addFriend()" class="btn game-btn"><i class="fas fa-user-plus"></i> –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div id="friendsList" class="row"></div>
                <div id="friendError" class="alert" style="display: none;"></div>
            </div>
            <div class="tab-pane fade" id="games" role="tabpanel">
                <div class="card p-3 mb-3">
                    <h3><i class="fas fa-dice"></i> –ò–≥—Ä–∞ "–ë–æ–ª—å—à–µ/–ú–µ–Ω—å—à–µ"</h3>
                    <p>–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100!</p>
                    <div class="input-group mb-3">
                        <input type="number" id="guessInput" placeholder="–¢–≤–æ—ë —á–∏—Å–ª–æ" class="form-control">
                        <button onclick="playGame()" class="btn game-btn"><i class="fas fa-play"></i> –°—ã–≥—Ä–∞—Ç—å</button>
                    </div>
                    <p id="gameResult"></p>
                </div>
            </div>
            <div class="tab-pane fade" id="tasks" role="tabpanel">
                <h3><i class="fas fa-tasks"></i> –ó–∞–¥–∞–Ω–∏—è</h3>
                <div id="tasksList" class="card p-3 mb-3">
                    <p id="task-welcome">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ: –ü–æ–ª—É—á–∏ +500 –º–æ–Ω–µ—Ç</p>
                    <button id="task-welcome-btn" onclick="completeTask('welcome')" class="btn game-btn"><i class="fas fa-check"></i> –í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
                </div>
                <div id="taskError" class="alert" style="display: none;"></div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.setText("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å").show().onClick(() => tg.sendData(JSON.stringify({action: 'save'})));

        // Security: Validate initData
        if (!tg.initDataUnsafe.user) {
            alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –û—Ç–∫—Ä–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.');
            tg.close();
        }

        const user = tg.initDataUnsafe.user || {username: 'unknown', id: 0};
        let balance = 1000;  // Should be fetched from backend
        document.getElementById('username').innerText = `Username: @${user.username || 'user' + user.id}`;
        document.getElementById('balance').innerText = `–ë–∞–ª–∞–Ω—Å: ${balance} üí∞`;

        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.innerText = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 3000);
        }

        function addFriend() {
            const username = document.getElementById('friendInput').value.trim();
            if (!username || !/^[a-zA-Z0-9_]{3,32}$/.test(username)) {
                showError('friendError', '–ù–µ–≤–µ—Ä–Ω—ã–π username (3-32 —Å–∏–º–≤–æ–ª–∞, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _).');
                return;
            }
            tg.sendData(JSON.stringify({action: 'add_friend', username}));
            showError('friendError', '–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
            document.getElementById('friendInput').value = '';
        }

        function playGame() {
            const guess = parseInt(document.getElementById('guessInput').value);
            if (!guess || guess < 1 || guess > 100) {
                showError('gameResult', '–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100!');
                return;
            }
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('startapp')?.split('_')[1];
            if (!gameId) {
                showError('gameResult', '–û—à–∏–±–∫–∞: –∏–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
                return;
            }
            // Simulated game logic (replace with backend API call)
            const secret = Math.floor(Math.random() * 100) + 1;  // Should fetch from backend
            let result;
            if (guess > secret) {
                result = '–ú–µ–Ω—å—à–µ!';
            } else if (guess < secret) {
                result = '–ë–æ–ª—å—à–µ!';
            } else {
                result = 'üèÜ –£–≥–∞–¥–∞–ª!';
                balance += 100;  // Update with actual stake from backend
                document.getElementById('balance').innerText = `–ë–∞–ª–∞–Ω—Å: ${balance} üí∞`;
                tg.sendData(JSON.stringify({
                    action: 'game_result',
                    game_id: gameId,
                    winner: user.username,
                    result: 'win',
                    user_id: user.id
                }));
            }
            document.getElementById('gameResult').innerText = `${result} (–°–µ–∫—Ä–µ—Ç: ${secret})`;
        }

        function completeTask(task) {
            tg.sendData(JSON.stringify({action: 'complete_task', task}));
            const taskElement = document.getElementById(`task-${task}`);
            const taskButton = document.getElementById(`task-${task}-btn`);
            if (taskElement && taskButton) {
                taskElement.remove();
                taskButton.remove();
                balance += 500;  // Update with actual reward
                document.getElementById('balance').innerText = `–ë–∞–ª–∞–Ω—Å: ${balance} üí∞`;
                showError('taskError', '–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! +500 –º–æ–Ω–µ—Ç');
                if (!document.querySelector('#tasksList .card')) {
                    document.getElementById('tasksList').innerHTML = '<p>–í—Å–µ –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!</p>';
                }
            }
        }

        // Handle URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const startApp = urlParams.get('startapp');
        if (startApp?.startsWith('game_')) {
            document.querySelector('#myTab button[data-bs-target="#games"]').click();
            document.getElementById('gameResult').innerText = `–ò–≥—Ä–∞ #${startApp.split('_')[1]} –Ω–∞—á–∞—Ç–∞!`;
        }
    </script>
</body>
</html>